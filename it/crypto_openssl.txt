OpenSSL: certificate generation for OpenLDAP
============================================

Set openssl defaults:
---------------------
/etc/pki/tls/openssl.cnf (OPENSSLDIR: openssl version -d)

[ req ]
default_bits = 2048
req_extensions = v3_req

# Share the same certificate among several servers
[ v3_req ]
subjectAltName=DNS:vm_centos1,DNS:vm_centos2
NB: DNS:host must be a fqdn as returned by hostname -f

CA self-signed certificate:
---------------------------
1. key pair generation
   cd /etc/openldap/cacerts &&
   openssl genrsa -out cakey.pem 2048
   chmod 600 cakey.pem
   Note: cakey.pem contains BOTH keys, same for serverkey.pem below

2. new self-signed certificate
   openssl req -new -x509 -days 1095 -key cakey.pem -out cacert.pem # -subj "/C=GB/ST=State/L=Locality/O=Org/OU=IT/CN=CA"

LDAP Master certificate:
------------------------
1. mkdir -p /etc/CA/{newcerts,private}
   touch /etc/CA/index.txt
   echo '01' > /etc/CA/serial ?
   (cd /etc/CA/private && ln -s /etc/openldap/cacerts/cakey.pem)
   (cd /etc/CA && ln -s /etc/openldap/cacerts/cacert.pem)

2. key pair generation + new CSR
   openssl req -new -nodes -keyout serverkey.pem -out server.csr # -subj "/C=GB/ST=State/L=Locality/O=Org/OU=IT/CN=ldap_master_hostname_fqdn"
   chmod 600 serverkey.pem

3. Sign the CSR in order to create a valid digital certificate
   openssl ca -days 1095 -extensions v3_req -in server.csr -out servercert.pem

4. chown ldap:ldap *

* Install cacert.pem, servercert.pem and serverkey.pem on the slave,
          cacert.pem on all clients

* /etc/openldap/cacerts must also contain a set of symlinks pointing to the
  certificate files, each named using a hash with extension .0 of the
  corresponding certificate's subject's Distinguished Name:

  for c in *cert.pem; do  ln -s "$c" $(openssl x509 -hash -in "$c" -noout).0; done

  http://jw35.blogspot.co.uk/2010/05/doing-certificate-verification-in.html
  man openssl-verify

Location with a bundle of certificates trusted by default:
/etc/pki/tls/certs on RedHat/Fedora
/etc/ssl/certs     on Ubuntu/Debian

CRL: certificate revocation list - permanent (revoked) or temporary (hold)

http://users.dcc.uchile.cl/~pcamacho/tutorial/crypto/openssl/openssl_intro.html#htoc6

Examples:
---------

# Key pair generation (gendsa if relevant)
openssl genrsa -out keys.pem 2048         # generate a public/private key pair
openssl genrsa -out keys.pem -aes256 2048 # with passphrase

# Key pair processing
openssl rsa -in keys.pem 2>/dev/null                # print the private key
openssl rsa -in keys.pem -pubout 2>/dev/null        # print the public key
openssl rsa -in keys.pem -text -noout               # print out the components of a key pair
openssl rsa -in keys.pem -outform DER -out keys.der # convert from PEM to DER format
openssl rsa -in keys.pem -out keys2.pem             # remove the pass phrase

# Certificate signing request or self signed certificate generation (see: PKCS#10)
openssl req -new -nodes -keyout keys.pem -out host.csr              # new CSR with key pair generation (no passphrase) beforehand
openssl req -new -x509 -days 1095 -key ca_keys.pem -out ca_cert.pem # new self signed certificate based on an existing key pair

# Certificate Authority
openssl ca -days 1095 -extensions v3_req -in host.csr -out host_cert.pem # Create a valid digital certificate by signing a CSR

# Certificate display and signing
openssl x509 -in host_cert.pem                # see certificate
openssl x509 -in host_cert.pem -noout -pubkey # print the public key

Notes:
* -noout: no private key output
* -text: key pair components
* pem: privacy enhanced email
* man genrsa|rsa|req|ca
* openssl enc -aes-256-cbc -in plain.txt -out encrypted.bin
* des < des3 < aes128 # data encryption standard < advanced encryption standard
               aes192
               aes256
